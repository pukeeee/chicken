#!/bin/bash
# –¶—è –∫–æ–º–∞–Ω–¥–∞ –∑–º—É—Å–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –Ω–µ–≥–∞–π–Ω–æ –∑—É–ø–∏–Ω–∏—Ç–∏—Å—è, —è–∫—â–æ —â–æ—Å—å –ø—ñ–¥–µ –Ω–µ —Ç–∞–∫
set -e

echo "üßπ –ü–æ—á–∏–Ω–∞—é –ø—Ä–∏–±–∏—Ä–∞–Ω–Ω—è —Å—Ç–∞—Ä–∏—Ö –≥—ñ–ª–æ–∫..."

# –ö—Ä–æ–∫ 1: –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ —Å—Ç–∞–Ω –∑ –≤—ñ–¥–¥–∞–ª–µ–Ω–∏–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—î–º
echo "--> –û—Ç—Ä–∏–º—É—é –∞–∫—Ç—É–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω –∑ GitHub —Ç–∞ –≤–∏–¥–∞–ª—è—é –Ω–µ—ñ—Å–Ω—É—é—á—ñ –≤—ñ–¥–¥–∞–ª–µ–Ω—ñ –≥—ñ–ª–∫–∏..."
git fetch --prune

# –ö—Ä–æ–∫ 2: –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Ç–∞ –∫–æ—Ä–µ–∫—Ç–Ω–æ –ø–∞—Ä—Å–∏–º–æ –Ω–∞–∑–≤–∏ –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏—Ö –≥—ñ–ª–æ–∫
echo "--> –®—É–∫–∞—é –ª–æ–∫–∞–ª—å–Ω—ñ –≥—ñ–ª–∫–∏ –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è..."
# awk —Ç–µ–ø–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–æ–±–ª—è—î –ø–æ—Ç–æ—á–Ω—É –≥—ñ–ª–∫—É, –ø–æ–∑–Ω–∞—á–µ–Ω—É —Å–∏–º–≤–æ–ª–æ–º '*'
STALE_BRANCHES=$(git branch -vv | grep ': gone]' | awk '{if ($1 == "*") {print $2} else {print $1}}' || true)

if [ -z "$STALE_BRANCHES" ]; then
  echo "‚úÖ –ù–µ–º–∞—î –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏—Ö –≥—ñ–ª–æ–∫. –í–∞—à –ª–æ–∫–∞–ª—å–Ω–∏–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π —á–∏—Å—Ç–∏–π!"
else
  echo "--> –ë—É–¥—É—Ç—å –≤–∏–¥–∞–ª–µ–Ω—ñ –Ω–∞—Å—Ç—É–ø–Ω—ñ –∑–∞—Å—Ç–∞—Ä—ñ–ª—ñ –≥—ñ–ª–∫–∏:"
  for BRANCH in $STALE_BRANCHES; do
    echo "    - $BRANCH"
  done
  
  echo "--> –í–∏–∫–æ–Ω—É—é –≤–∏–¥–∞–ª–µ–Ω–Ω—è..."
  # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ü–∏–∫–ª while read –¥–ª—è –±—ñ–ª—å—à –±–µ–∑–ø–µ—á–Ω–æ—ó –æ–±—Ä–æ–±–∫–∏ –Ω–∞–∑–≤
  echo "$STALE_BRANCHES" | while read -r branch; do
    # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ git branch -D –¥–ª—è –ø—Ä–∏–º—É—Å–æ–≤–æ–≥–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è, –æ—Å–∫—ñ–ª—å–∫–∏ –≥—ñ–ª–∫–∏ –º–æ–∂—É—Ç—å –±—É—Ç–∏ "–Ω–µ –ø–æ–≤–Ω—ñ—Å—Ç—é –∑–ª–∏—Ç—ñ"
    git branch -D "$branch"
  done
  echo "‚úÖ –ü—Ä–∏–±–∏—Ä–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
fi