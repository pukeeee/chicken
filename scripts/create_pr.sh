#!/bin/bash
# –¶—è –∫–æ–º–∞–Ω–¥–∞ –∑–º—É—Å–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –Ω–µ–≥–∞–π–Ω–æ –∑—É–ø–∏–Ω–∏—Ç–∏—Å—è, —è–∫—â–æ —â–æ—Å—å –ø—ñ–¥–µ –Ω–µ —Ç–∞–∫
set -e

# --- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ---
BASE_BRANCH="master"
AUTOMEGE_LABEL="automerge"
# --------------------

# 1. –û—Ç—Ä–∏–º—É—î–º–æ –Ω–∞–∑–≤—É –ø–æ—Ç–æ—á–Ω–æ—ó –≥—ñ–ª–∫–∏
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# 2. –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –º–∏ –Ω–µ –Ω–∞ master –≥—ñ–ª—Ü—ñ
if [ "$CURRENT_BRANCH" == "$BASE_BRANCH" ]; then
  echo "‚ùå –ü–æ–º–∏–ª–∫–∞: –í–∏ –∑–Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –Ω–∞ –≥—ñ–ª—Ü—ñ '$BASE_BRANCH'. –°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–π–¥—ñ—Ç—å –Ω–∞ —Å–≤–æ—é –≥—ñ–ª–∫—É –∑ —Ñ—ñ—á–µ—é."
  exit 1
fi

# 3. –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Å—Ç–∞–Ω –≥—ñ–ª–æ–∫ –∑ GitHub
echo "üîÑ –û–Ω–æ–≤–ª—é—é —Å—Ç–∞–Ω –≥—ñ–ª–æ–∫ –∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é..."
git fetch origin "$BASE_BRANCH"

# 4. –ì–µ–Ω–µ—Ä—É—î–º–æ –Ω–∞–∑–≤—É –¥–ª—è PR –∑ –ø–µ—Ä—à–æ–≥–æ –∫–æ–º–º—ñ—Ç—É –≤ –≥—ñ–ª—Ü—ñ (–ø–æ—Ä—ñ–≤–Ω—é—é—á–∏ –∑ origin/master)
PR_TITLE=$(git log "origin/$BASE_BRANCH..HEAD" --reverse --pretty=format:"%s" | head -n 1)

# 5. –ì–µ–Ω–µ—Ä—É—î–º–æ —Ç—ñ–ª–æ –¥–ª—è PR –∑—ñ —Å–ø–∏—Å–∫–æ–º –≤—Å—ñ—Ö –∫–æ–º–º—ñ—Ç—ñ–≤ (–ø–æ—Ä—ñ–≤–Ω—é—é—á–∏ –∑ origin/master)
COMMIT_LIST=$(git log "origin/$BASE_BRANCH..HEAD" --pretty=format:"- %s%n")

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î –≤–∑–∞–≥–∞–ª—ñ –∫–æ–º–º—ñ—Ç–∏ –¥–ª—è PR
if [ -z "$PR_TITLE" ]; then
  echo "‚ùå –ü–æ–º–∏–ª–∫–∞: –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –Ω–æ–≤–∏—Ö –∫–æ–º–º—ñ—Ç—ñ–≤ —É –≥—ñ–ª—Ü—ñ '$CURRENT_BRANCH' –ø–æ—Ä—ñ–≤–Ω—è–Ω–æ –∑ '$BASE_BRANCH'."
  echo "–ú–æ–∂–ª–∏–≤–æ, –≤–∏ –∑–∞–±—É–ª–∏ –∑—Ä–æ–±–∏—Ç–∏ –∫–æ–º–º—ñ—Ç –∞–±–æ –≤–∞—à–∞ –≥—ñ–ª–∫–∞ –Ω–µ –≤—ñ–¥—Ä—ñ–∑–Ω—è—î—Ç—å—Å—è –≤—ñ–¥ master."
  exit 1
fi

PR_BODY="### –ó–º—ñ–Ω–∏ –≤ —Ü—å–æ–º—É PR:

${COMMIT_LIST}
---
*PR —Å—Ç–≤–æ—Ä–µ–Ω–æ —Ç–∞ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.*"

echo "–°—Ç–≤–æ—Ä—é—é Pull Request..."
echo "======================="
echo "  –ì—ñ–ª–∫–∞:    $CURRENT_BRANCH -> $BASE_BRANCH"
echo "  –ù–∞–∑–≤–∞:    $PR_TITLE"
echo "  –ú—ñ—Ç–∫–∞:    $AUTOMEGE_LABEL"
echo "--- –¢—ñ–ª–æ PR: ---"
echo "$PR_BODY"
echo "------------------"

# 6. –°—Ç–≤–æ—Ä—é—î–º–æ Pull Request –∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏
gh pr create \
  --base "$BASE_BRANCH" \
  --head "$CURRENT_BRANCH" \
  --title "$PR_TITLE" \
  --body "$PR_BODY" \
  --label "$AUTOMEGE_LABEL"

echo "‚úÖ Pull Request —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ!"